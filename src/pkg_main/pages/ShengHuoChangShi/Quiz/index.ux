<template>
  <div class="page-container">
    <!-- 顶部背景 -->
    <div class="top-section">
      <image
        class="top-bg-img"
        src="/pkg_main/assets/img/shouyedingbg-1.png"
      ></image>
      <div class="header-overlay">
        <div class="navbar">
          <div class="nav-back_btn" onclick="goBack">
            <image
              src="/pkg_main/assets/img/back.png"
              class="back-icon"
            ></image>
          </div>
          <text class="nav-title">答题测试</text>
        </div>
      </div>
    </div>

    <!-- 主内容区 -->
    <div class="main-content">
      <!-- 进度条卡片 -->
      <div class="progress-card">
        <div class="progress-info">
          <div class="progress-labels">
            <text class="progress-text-bold">第{{ currentIndex + 1 }}题</text>
            <text class="progress-text-gray"> / 共{{ totalQuestions }}题</text>
          </div>
          <text class="accuracy-text">正确率: {{ accuracy }}%</text>
        </div>
        <div class="progress-bar-bg">
          <div
            class="progress-bar-fill"
            style="width: {{progressPercent}}%;"
          ></div>
        </div>
      </div>

      <!-- 题目卡片 -->
      <div class="question-card">
        <div class="question-type-tag">
          <text class="tag-text">单选题</text>
        </div>

        <text class="question-title">{{ currentQuestion.question }}</text>

        <div class="options-list">
          <div
            class="option-item {{getOptionClass(index)}}"
            for="{{(index, item) in currentQuestion.options}}"
            onclick="selectOption(index)"
          >
            <text class="option-text">{{ item }}</text>

            <!-- 状态图�?-->
            <div class="status-icon-container" if="{{isSubmitted}}">
              <div
                class="icon-circle icon-correct"
                if="{{index === correctOptionIndex}}"
              >
                <text class="icon-text">√</text>
              </div>
              <!-- 选错了才显示 x.png -->
              <image
                class="status-img-wrong"
                src="/pkg_main/assets/img/x.png"
                if="{{index === selectedOptionIndex && index !== correctOptionIndex}}"
              ></image>
            </div>

            <!-- 选中状�?未提�? -->
            <div
              class="radio-checked"
              if="{{!isSubmitted && index === selectedOptionIndex}}"
            >
              <div class="radio-inner"></div>
            </div>
          </div>
        </div>

        <!-- 结果展示区域 (已提交显�? -->
        <div class="result-area" if="{{isSubmitted}}">
          <text class="result-label"
            >正确答案:
            <span style="color: #00d3ff; font-weight: bold;">{{
              formatOptionIndex(correctOptionIndex)
            }}</span></text
          >
          <text class="result-label ml-20"
            >你的答案:
            <span
              style="color: {{selectedOptionIndex === correctOptionIndex ? '#00d3ff' : '#FFAA00'}}; font-weight: bold;"
              >{{ formatOptionIndex(selectedOptionIndex) }}</span
            ></text
          >
        </div>
      </div>
    </div>

    <!-- 底部按钮�?-->
    <div class="bottom-area">
      <div if="{{!isSubmitted}}" class="btn-primary" onclick="submitAnswer">
        <text class="btn-text">确定</text>
      </div>
      <div if="{{isSubmitted}}" class="btn-group">
        <div class="btn-secondary" onclick="showAnalysisDialog">
          <text class="btn-text-secondary">查看解析</text>
        </div>
        <div class="btn-primary flex-1 ml-20" onclick="nextQuestion">
          <text class="btn-text">{{
            currentIndex === totalQuestions - 1 ? '完成测试' : '下一题'
          }}</text>
        </div>
      </div>
    </div>

    <!-- 解析弹窗 (遮罩 + 内容) -->
    <div if="{{showAnalysis}}" class="modal-mask">
      <div class="modal-content">
        <text class="modal-title">解析</text>
        <text class="modal-desc">{{ currentQuestion.analysis }}</text>
        <div class="modal-btn" onclick="closeAnalysisDialog">
          <text class="modal-btn-text">我已了解</text>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
import router from '@system.router'
import prompt from '@system.prompt'
import storage from '@system.storage'
import { lifeKnowledgeQuestions as allQuestionsDetail } from '../../../helper/shenghuo.js'

export default {
  data: {
    allQuestions: [],
    quizQuestions: [],
    currentIndex: 0,
    totalQuestions: 10, // 每天固定10道题
    correctCount: 0,
    totalDays: 0, // 累计答题天数

    currentQuestion: {
      question: '',
      options: [],
      answer: '',
      analysis: ''
    },

    selectedOptionIndex: -1,
    isSubmitted: false,
    showAnalysis: false
  },

  onInit() {
    this.checkTodayProgress()
  },

  onHide() {
    // 页面隐藏时保存进度（包括答对题数和正确率）
    this.saveCurrentProgress()
  },

  onDestroy() {
    // 页面销毁时保存进度
    this.saveCurrentProgress()
  },

  // 保存当前完整进度（包括答对题数、正确率等）
  saveCurrentProgress() {
    // 如果还有未完成的题目，保存当前进度
    if (
      this.currentIndex < 10 &&
      this.quizQuestions &&
      this.quizQuestions.length > 0
    ) {
      // 计算当前正确率（基于已答题数）
      const answeredCount = this.currentIndex // 当前索引就是已答题数
      if (answeredCount > 0) {
        const rate = Math.round((this.correctCount / answeredCount) * 100)
        storage.set({
          key: 'shcs_todayCorrect',
          value: String(this.correctCount)
        })
        storage.set({ key: 'shcs_correctRate', value: rate + '%' })
      }
    }
  },

  // 检查今日答题进度
  checkTodayProgress() {
    const today = new Date().toDateString()
    storage.get({
      key: 'shcs_quizDate',
      success: dateData => {
        if (dateData === today) {
          // 今天已有答题记录，检查是否完成
          storage.get({
            key: 'shcs_quizCompleted',
            success: completedData => {
              if (completedData === 'true') {
                // 今日已完成，跳转结果页
                this.loadTodayResult()
              } else {
                // 今日未完成，恢复进度继续答题
                this.loadProgress()
              }
            },
            fail: () => {
              this.loadProgress()
            }
          })
        } else {
          // 新的一天，开始新的答题
          this.startNewQuiz()
        }
      },
      fail: () => {
        // 没有记录，开始新的答题
        this.startNewQuiz()
      }
    })
  },

  // 加载今日已完成的结果
  loadTodayResult() {
    storage.get({
      key: 'shcs_todayCorrect',
      success: correctData => {
        const correctCount = parseInt(correctData) || 0
        storage.get({
          key: 'shcs_totalDays',
          success: daysData => {
            const totalDays = parseInt(daysData) || 1
            router.replace({
              uri: 'pkg_main/pages/ShengHuoChangShi/Result',
              params: {
                score: Math.round((correctCount / 10) * 100),
                correctCount: correctCount,
                totalCount: 10,
                totalDays: totalDays
              }
            })
          },
          fail: () => {
            router.replace({
              uri: 'pkg_main/pages/ShengHuoChangShi/Result',
              params: {
                score: Math.round((correctCount / 10) * 100),
                correctCount: correctCount,
                totalCount: 10,
                totalDays: 1
              }
            })
          }
        })
      },
      fail: () => {
        this.startNewQuiz()
      }
    })
  },

  // 恢复答题进度
  loadProgress() {
    storage.get({
      key: 'shcs_quizQuestions',
      success: questionsData => {
        try {
          const savedQuestions = JSON.parse(questionsData)

          // 验证数据格式
          if (
            !Array.isArray(savedQuestions) ||
            savedQuestions.length === 0 ||
            !savedQuestions[0].question
          ) {
            console.log('存储数据格式错误，重新开始')
            this.clearStorageAndStart()
            return
          }

          this.quizQuestions = savedQuestions
          this.totalQuestions = 10

          storage.get({
            key: 'shcs_currentIndex',
            success: indexData => {
              this.currentIndex = parseInt(indexData) || 0

              storage.get({
                key: 'shcs_correctCount',
                success: correctData => {
                  this.correctCount = parseInt(correctData) || 0

                  storage.get({
                    key: 'shcs_totalDays',
                    success: daysData => {
                      this.totalDays = parseInt(daysData) || 0
                      this.loadQuestion(this.currentIndex)
                    },
                    fail: () => {
                      this.totalDays = 0
                      this.loadQuestion(this.currentIndex)
                    }
                  })
                },
                fail: () => {
                  this.correctCount = 0
                  this.loadQuestion(this.currentIndex)
                }
              })
            },
            fail: () => {
              this.loadQuestion(0)
            }
          })
        } catch (e) {
          console.log('解析存储数据失败:', e)
          this.clearStorageAndStart()
        }
      },
      fail: () => {
        this.startNewQuiz()
      }
    })
  },

  // 清空存储并重新开始
  clearStorageAndStart() {
    const keys = [
      'shcs_quizDate',
      'shcs_quizQuestions',
      'shcs_currentIndex',
      'shcs_correctCount',
      'shcs_quizCompleted',
      'shcs_categoryIndex'
    ]
    keys.forEach(key => {
      storage.delete({ key })
    })
    this.startNewQuiz()
  },

  // 开始新的一天答题
  startNewQuiz() {
    const today = new Date().toDateString()

    // 获取累计答题天数，用于确定今天展示哪个分类
    storage.get({
      key: 'shcs_totalDays',
      success: daysData => {
        this.totalDays = parseInt(daysData) || 0
        this.initTodayCategory(today)
      },
      fail: () => {
        this.totalDays = 0
        this.initTodayCategory(today)
      }
    })
  },

  // 根据累计天数选择今日分类
  initTodayCategory(today) {
    // 检查数据是否加载成功
    if (
      !allQuestionsDetail ||
      !Array.isArray(allQuestionsDetail) ||
      allQuestionsDetail.length === 0
    ) {
      prompt.showToast({ message: '题目数据加载失败' })
      setTimeout(() => {
        router.back()
      }, 1500)
      return
    }

    // 开始新一天的答题，累计天数+1
    this.totalDays++
    storage.set({ key: 'shcs_totalDays', value: String(this.totalDays) })

    // 共有10个分类，每天一个分类，循环展示
    const totalCategories = allQuestionsDetail.length // 10个分类
    // 注意：因为已经+1了，所以这里用 (totalDays - 1) 来确定分类
    const categoryIndex = (this.totalDays - 1) % totalCategories

    // 获取今日分类的题目
    const todayCategory = allQuestionsDetail[categoryIndex]

    if (
      todayCategory &&
      todayCategory.questions &&
      todayCategory.questions.length > 0
    ) {
      // 打乱该分类的题目顺序
      this.quizQuestions = this.shuffleArray([...todayCategory.questions])
      this.totalQuestions = this.quizQuestions.length // 应该是10道
      this.currentIndex = 0
      this.correctCount = 0

      // 保存今日日期、分类索引和题目
      storage.set({ key: 'shcs_quizDate', value: today })
      storage.set({ key: 'shcs_categoryIndex', value: String(categoryIndex) })
      storage.set({
        key: 'shcs_quizQuestions',
        value: JSON.stringify(this.quizQuestions)
      })
      storage.set({ key: 'shcs_currentIndex', value: '0' })
      storage.set({ key: 'shcs_correctCount', value: '0' })
      storage.set({ key: 'shcs_quizCompleted', value: 'false' })

      this.loadQuestion(0)
    } else {
      prompt.showToast({ message: '暂无题目数据' })
      setTimeout(() => {
        router.back()
      }, 1500)
    }
  },

  shuffleArray(array) {
    let m = array.length,
      t,
      i
    while (m) {
      i = Math.floor(Math.random() * m--)
      t = array[m]
      array[m] = array[i]
      array[i] = t
    }
    return array
  },

  loadQuestion(index) {
    if (!this.quizQuestions || this.quizQuestions.length === 0) {
      prompt.showToast({ message: '题目加载失败' })
      return
    }

    if (index < 0 || index >= this.quizQuestions.length) {
      return
    }

    const question = this.quizQuestions[index]
    if (!question) {
      prompt.showToast({ message: '题目数据异常' })
      return
    }

    this.currentIndex = index
    this.currentQuestion = question
    this.selectedOptionIndex = -1
    this.isSubmitted = false
    this.showAnalysis = false
  },

  selectOption(index) {
    if (this.isSubmitted) return
    this.selectedOptionIndex = index
  },

  submitAnswer() {
    if (this.selectedOptionIndex === -1) {
      prompt.showToast({ message: '请先选择一个答案' })
      return
    }
    this.isSubmitted = true

    // 检查正确与否
    if (this.selectedOptionIndex === this.correctOptionIndex) {
      this.correctCount++
    }

    // 计算并保存当前正确率和答对题数（实时更新）
    const currentAnswered = this.currentIndex + 1 // 已答题数
    const rate = Math.round((this.correctCount / currentAnswered) * 100)
    storage.set({ key: 'shcs_todayCorrect', value: String(this.correctCount) })
    storage.set({ key: 'shcs_correctRate', value: rate + '%' })

    // 保存答对题数
    storage.set({ key: 'shcs_correctCount', value: String(this.correctCount) })

    // 如果不是最后一题，保存下一题的索引（用户下次从下一题开始）
    if (this.currentIndex < 9) {
      storage.set({
        key: 'shcs_currentIndex',
        value: String(this.currentIndex + 1)
      })
    }

    // 如果是第10题（最后一题）且已提交，标记今日完成
    if (this.currentIndex === 9) {
      // 最后一题提交后，标记今日完成（累计天数已在开始答题时+1）
      storage.set({ key: 'shcs_quizCompleted', value: 'true' })
      storage.set({ key: 'shcs_currentIndex', value: '10' }) // 标记已完成所有题目
    }
  },

  // 保存答题进度（仅在特殊情况下调用）
  saveProgress() {
    storage.set({ key: 'shcs_currentIndex', value: String(this.currentIndex) })
    storage.set({ key: 'shcs_correctCount', value: String(this.correctCount) })
  },

  nextQuestion() {
    if (this.currentIndex < this.totalQuestions - 1) {
      this.loadQuestion(this.currentIndex + 1)
      // 保存新的题目位置
      storage.set({
        key: 'shcs_currentIndex',
        value: String(this.currentIndex)
      })
    } else {
      // 测试完成，跳转结果页
      router.replace({
        uri: 'pkg_main/pages/ShengHuoChangShi/Result',
        params: {
          score: Math.round((this.correctCount / this.totalQuestions) * 100),
          correctCount: this.correctCount,
          totalCount: this.totalQuestions,
          totalDays: this.totalDays
        }
      })
    }
  },

  showAnalysisDialog() {
    this.showAnalysis = true
  },

  closeAnalysisDialog() {
    this.showAnalysis = false
  },

  goBack() {
    // 退出时保存进度（如果今日未完成）
    storage.get({
      key: 'shcs_quizCompleted',
      success: completedData => {
        if (completedData !== 'true') {
          this.saveProgress()
        }
        router.back()
      },
      fail: () => {
        this.saveProgress()
        router.back()
      }
    })
  },

  formatOptionIndex(index) {
    const letters = ['A', 'B', 'C', 'D', 'E']
    return letters[index] || ''
  },

  getOptionClass(index) {
    if (!this.isSubmitted) {
      return index === this.selectedOptionIndex ? 'option-selected' : ''
    } else {
      if (index === this.correctOptionIndex) {
        return 'option-correct'
      }
      if (
        index === this.selectedOptionIndex &&
        index !== this.correctOptionIndex
      ) {
        return 'option-wrong'
      }
      return 'option-disabled'
    }
  },

  computed: {
    correctOptionIndex() {
      if (!this.currentQuestion || !this.currentQuestion.answer) return -1
      const map = { A: 0, B: 1, C: 2, D: 3 }
      return map[this.currentQuestion.answer] || 0
    },
    progressPercent() {
      if (this.totalQuestions === 0) return 0
      return ((this.currentIndex + 1) / this.totalQuestions) * 100
    },
    accuracy() {
      let answered = this.currentIndex
      if (this.isSubmitted) {
        answered += 1
      }
      if (answered === 0) return 0
      return Math.round((this.correctCount / answered) * 100)
    }
  }
}
</script>

<style>
.page-container {
  flex-direction: column;
  background-color: #f5f7fa;
  height: 100%;
}

.top-section {
  width: 100%;
  height: 120px;
  position: relative;
  flex-direction: column;
}

.top-bg-img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  position: absolute;
  top: 0;
  left: 0;
}

.header-overlay {
  width: 100%;
  height: 100%;
  flex-direction: column;
}

.navbar {
  position: absolute;
  top: 15px; /* 状态栏适配 */
  left: 0;
  width: 100%;
  height: 30px;
  flex-direction: row;
  align-items: center;
  padding: 0 15px;
  z-index: 10;
  justify-content: center;
}

.nav-back_btn {
  position: absolute;
  left: 15px;
  width: 20px;
  height: 20px;
  justify-content: center;
  align-items: center;
  background-color: rgba(255, 255, 255, 0.5);
  border-radius: 14px;
}

.back-icon {
  width: 12px;
  height: 12px;
  object-fit: contain;
}

.nav-title {
  font-size: 14px;
  color: #171717;
  font-weight: bold;
  lines: 1;
  text-overflow: ellipsis;
  text-align: center;
}

.main-content {
  flex-direction: column;
  width: 100%;
  padding-left: 10px;
  padding-right: 10px;
  margin-top: -40px;
  margin-bottom: 5px;
  flex: 1;
}

/* 进度卡片 */
.progress-card {
  width: 100%;
  background-color: #ffffff;
  border-radius: 8px;
  padding: 10px;
  flex-direction: column;
  margin-bottom: 10px;
}

.progress-info {
  flex-direction: row;
  justify-content: space-between;
  align-items: flex-end;
  margin-bottom: 6px;
}

.progress-labels {
  flex-direction: row;
  align-items: flex-end;
}

.progress-text-bold {
  font-size: 13px;
  color: #171717;
  font-weight: bold;
}

.progress-text-gray {
  font-size: 10px;
  color: #999999;
  margin-bottom: 2px;
}

.accuracy-text {
  font-size: 10px;
  color: #999999;
  margin-bottom: 2px;
}

.progress-bar-bg {
  width: 100%;
  height: 4px;
  background-color: #ffece0;
  border-radius: 2px;
}

.progress-bar-fill {
  height: 100%;
  background-color: #ff9d48;
  border-radius: 2px;
  transition-property: width;
  transition-duration: 500ms;
  transition-timing-function: ease-out;
}

/* 题目卡片 */
.question-card {
  width: 100%;
  flex: 1;
  background-color: #ffffff;
  border-radius: 8px;
  padding: 12px;
  flex-direction: column;
  margin-bottom: 8px;
}

.question-type-tag {
  background-color: #e6f7ff;
  border-radius: 3px;
  padding: 2px 6px;
  align-self: flex-start;
  margin-bottom: 10px;
}

.tag-text {
  font-size: 10px;
  color: #0091ff;
  font-weight: bold;
}

.question-title {
  font-size: 14px;
  color: #333333;
  line-height: 22px;
  font-weight: bold;
  margin-bottom: 15px;
}

.options-list {
  flex-direction: column;
  width: 100%;
}

.option-item {
  width: 100%;
  background-color: #f8f8f8;
  border: 1px solid #f8f8f8;
  border-radius: 6px;
  padding: 10px 12px;
  margin-bottom: 8px;
  flex-direction: row;
  align-items: center;
  justify-content: space-between;
}

.option-text {
  font-size: 12px;
  color: #333333;
  flex: 1;
}

.option-selected {
  background-color: #f0fbff;
  border-color: #00d3ff;
}

.option-correct {
  background-color: #f0fbff;
  border-color: #00d3ff;
}

.option-wrong {
  background-color: #fff8e1;
  border-color: #ffaa00;
}

.option-disabled {
  opacity: 1;
}

/* 单选框模拟 */
.radio-checked {
  width: 16px;
  height: 16px;
  border-radius: 8px;
  background-color: #00d3ff;
  justify-content: center;
  align-items: center;
}
.radio-inner {
  width: 6px;
  height: 4px;
  border-left-width: 1px;
  border-bottom-width: 1px;
  border-color: #ffffff;
  transform: rotate(-45deg);
  margin-top: -2px;
}

/* 状态图�?*/
.status-icon-container {
  width: 16px;
  height: 16px;
  justify-content: center;
  align-items: center;
}
.icon-circle {
  width: 16px;
  height: 16px;
  border-radius: 8px;
  justify-content: center;
  align-items: center;
}
.icon-correct {
  background-color: #00d3ff;
}
.icon-wrong {
  background-color: #ff4d4f;
}
.icon-text {
  color: #ffffff;
  font-size: 11px;
  font-weight: bold;
}

.status-img-wrong {
  width: 16px;
  height: 16px;
  object-fit: contain;
}

/* 结果�?*/
.result-area {
  flex-direction: row;
  margin-top: 8px;
  padding: 4px 0;
  align-items: center;
}
.result-label {
  font-size: 11px;
  color: #666666;
}
.ml-20 {
  margin-left: 15px;
}

/* 底部区域 */
.bottom-area {
  width: 100%;
  padding: 8px 10px 15px 10px;
  background-color: #f5f7fa;
}

.btn-primary {
  width: 100%;
  height: 35px;
  background-color: #00d3ff;
  border-radius: 18px;
  justify-content: center;
  align-items: center;
}

.btn-secondary {
  width: 90px;
  height: 35px;
  background-color: #000000;
  border-radius: 18px;
  justify-content: center;
  align-items: center;
}

.btn-group {
  flex-direction: row;
  width: 100%;
  justify-content: space-between;
}

.btn-text {
  font-size: 13px;
  color: #ffffff;
  font-weight: bold;
}

.btn-text-secondary {
  font-size: 13px;
  color: #ffffff;
  font-weight: bold;
}

.flex-1 {
  flex: 1;
}

/* 弹窗 */
.modal-mask {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0, 0, 0, 0.7);
  justify-content: center;
  align-items: center;
  padding: 20px;
  z-index: 999;
}

.modal-content {
  width: 100%;
  background-color: #ffffff;
  background: linear-gradient(to bottom, #ffcf96, #ffffff 40%);
  border-radius: 12px;
  padding: 20px 18px 18px 18px;
  flex-direction: column;
  align-items: center;
}

.modal-title {
  font-size: 16px;
  font-weight: bold;
  color: #000000;
  margin-bottom: 16px;
}

.modal-desc {
  font-size: 13px;
  color: #333333;
  line-height: 20px;
  margin-bottom: 20px;
  text-align: left;
}

.modal-btn {
  width: 100%;
  height: 38px;
  background-color: #00d3ff;
  border-radius: 20px;
  justify-content: center;
  align-items: center;
}

.modal-btn-text {
  color: #ffffff;
  font-size: 14px;
  font-weight: bold;
}
</style>
